# 金峰项目开发文档
---

**系统整体架构**  
flask + socketIO + mongodb + redis  
flask负责展示数据以及用户的交互，socketIO连接远程设备，连接的远程设备信息存入redis，其余数据存入mongo。    

**socketIO部分**  
socketIO用于连接远程设备，设备首次连接成功会发送设备id，将设备id，socket，ip，port存入redis。设备发送的心跳包检测设备是否断连，如断连则清除redis中的数据，并更新设备状态，上线或者下线。设备信息、设备采集数据保持轮询主动获取。采集数据根据用户设定周期获取，送电断电根据用户计划执行。送电断电生成日志和时间，包括时间、操作、操作人员、地点。  
  
**flask后端**
  
**用户模块**  
用户分为4级权限：
1. 公司总负责人
2. 项目负责人
3. 项目运维操作员
4. 项目普通员工  

用户表设计  
用户名、密码、权限等级、公司名称、公司id、项目名称、项目id  
用户注册采用微信小程序注册，采用邀请形式，公司负责人可以生成激活码激活员工账号，同时用一张表记录激活码状态。  

激活码表设计  
激活码、激活用户id、激活状态

**设备模块**  
设备出场时需要设置设备ID、采集器ID、出场时间、保修期以及所属企业。  
企业可以修改设备所属项目、物理位置、设备别名。  

设备表设计  
设备ID、采集器ID、出场时间、保修期、所属企业、所属企业ID、项目名称、项目id、设备别名、物理位置  

**采集模块**  
电能信息采集采用主动发送采集要求的形式，根据用户设定的采集周期，创建定时任务向设备发送TCP请求，将读取到的电能数据存入表中。电能数据与用户预设电流阈值进行比较，异常数据生成事件。  

电能信息表设计  
设备ID、电表信息、创建时间  

网络信号强度、版本信息、电闸状态等信息采用设备主动发送的形式，数据存入redis中，如果设备掉线则清除信息。  

采集到通/断电信息记录至数据库。  
表设计  
设备ID、通/断电情况、创建时间  

同时记录通电时常断电时常用于统计  
表设计  
设备id、当天整点时间、时间数组(包括开始时间、停止时间)、通/断电状态  

**统计模块**  
统计采用定时任务对每天的电能、通断电时长、通断电次数、事件次数做统计。  

**控制模块**  
用户远程控制设备通电/断电，生成一个事件、在一定时间内设备没有返回确认信息则为超时。  
表设计  
用户id、操作时间、操作动作、成功状态  

用户设定通/断电计划，生成定时任务。
